<!DOCTYPE html>
<html layout:decorate="~{layout}">

<div layout:fragment="content">
  <header th:replace="~{header :: headerFragment}"></header>

    <main>
      <!-- サイト情報 -->
      <div class="container">
        <div class="row">
          <div class="col-md-2">
            <div class="row p-5"></div>
            <nav class="nav nav-pills flex-column position-fixed">
              <a class="nav-link" href="#item-1">サイト管理</a>
              <a class="nav-link" href="#item-2">ユーザー管理</a>
              <a class="nav-link" href="#item-3">レシピ管理</a>
            </nav>
          </div>
          <div class="container">
            <div class="row p-3 text-center justify-content-center" id="item-1">
              <div
                data-bs-spy="scroll"
                data-bs-target="navbar-myPage"
                data-bs-offset="0"
                tabindex="0"
              >
                <div class="container-fluid">
                  <div class="row text-center justify-content-center">
                    <div class="col-md-12">
                      <h1>サイト管理</h1>
                    </div>
                  </div>
                </div>
                <div class="container-fluid">
                  <div class="row justify-content-center p-5">
                    <div class="col-md-7">
                      <hr />
                    </div>
                  </div>
                </div>
                <div class="container-fluid">
                  <!-- 日別会員登録、接続者 -->
                  <div class="row text-center justify-content-center">
                    <div class="col-md-12">
                      <h3>会員登録、接続者グラフ</h3>
                    </div>
                  </div>
                </div>
                <div class="container-fluid">
                  <div class="row text-center justify-content-center">
                    <div class="col-md-4">
                      <div class="card">
                        <div class="card-body">
                          <canvas id="registrationsChart"></canvas>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="card">
                        <div class="card-body">
                          <canvas id="visitorsChart"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="container-fluid">
                  <div class="row justify-content-center p-5">
                    <div class="col-md-7">
                      <hr />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- ユーザー情報 -->
          <div class="container-fluid" id="item-2">
            <div class="row text-center justify-content-center">
              <div class="col-md-auto">
                <h1>ユーザー管理</h1>
              </div>
            </div>
          </div>
          <div class="container-fluid">
            <div class="row justify-content-center p-5">
              <div class="col-md-7">
                <hr />
              </div>
            </div>
          </div>
          <div class="container-fluid">
            <div class="row text-center justify-content-center">
              <!-- ユーザー数 -->
              <div class="col-md-auto">
                <h3>ユーザー総計&nbsp;</h3>
                <h5>00人</h5>
              </div>
              <!-- ユーザー情報修正、削除 -->
              <div class="col-md-auto">
                <h3>ユーザー情報修正、削除</h3>
              </div>
            </div>
          </div>
          <div class="container-fluid">
            <div class="row justify-content-center p-5">
              <div class="col-md-7">
                <hr />
              </div>
            </div>
          </div>
          <!-- レシピ情報 -->
          <div class="container-fluid" id="item-3">
            <div class="row justify-content-center text-center">
              <div class="col-md-auto">
                <h1>レシピ管理</h1>
              </div>
            </div>
          </div>
          <div class="container-fluid">
            <div class="row justify-content-center p-5">
              <div class="col-md-7">
                <hr />
              </div>
            </div>
          </div>
          <div class="container-fluid">
            <div class="row justify-content-center text-center">
              <!-- レシピ数 -->
              <div class="col-md-auto">
                <h3>レシピ総計&nbsp;</h3>
                <h5>00人</h5>
              </div>
              <!-- レシピ修正、削除 -->
              <div class="col-md-auto">
                <h3>レシピ情報修正、削除</h3>
              </div>
            </div>
          </div>
          <div class="container-fluid">
            <div class="row justify-content-center p-5">
              <div class="col-md-7">
                <hr />
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="bg-light mt-3 p-3 text-center">
      <p>Recipe Management Site &copy; 2023</p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- チャートスクリプト -->

  </div>
<script layout:fragment="script" type="text/javascript">
  async function fetchData() {
  try {
    const response = await fetch("/admin/dashboard");
    if (response.ok) {
      const data = await response.json();

      const monthlyRegisteredUsers = Array.from(data.monthlyRegisteredUsers, ([month, count]) => ({ month, count }));
      const monthlySiteVisits = Array.from(data.monthlySiteVisits, ([month, count]) => ({ month, count }));

      // 회원가입 차트 생성
      createChart("registrationsChart", "월별 회원가입자 수", monthlyRegisteredUsers);

      // 방문자 차트 생성
      createChart("visitorsChart", "월별 방문자 수", monthlySiteVisits);

    } else {
      console.error("Error fetching dashboard data:", response.status);
    }
  } catch (error) {
    console.error("Error:", error);
  }
}

function createChart(elementId, label, data) {
  const ctx = document.getElementById(elementId).getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: data.map(item => item.month),
      datasets: [{
        label: label,
        data: data.map(item => item.count),
        backgroundColor: "rgba(75, 192, 192, 0.2)",
        borderColor: "rgba(75, 192, 192, 1)",
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
}

// 데이터를 가져오고 차트를 초기화합니다.
fetchData();
</script>
</html>
