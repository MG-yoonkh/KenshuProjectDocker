<html layout:decorate="~{layout}">
  <div layout:fragment="content">
    <link rel="stylesheet" type="text/css" th:href="@{/css/writeRecipe.css}" />
    <header th:replace="~{header :: headerFragment}"></header>
    <main>
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-2"></div>
          <div class="col-md-auto">
            <form th:object="${recipeForm}" method="post" enctype="multipart/form-data">
              <input
                type="hidden"
                th:name="${_csrf.parameterName}"
                th:value="${_csrf.token}"
              />
              <div class="alert alert-danger" role="alert" th:if="${#fields.hasAnyErrors()}" >
                <div th:each="err : ${#fields.allErrors()}" th:text="${err}" />
              </div>
              <div class="row justify-content-center">
                <div class="text-center" id="">
                  <h1 class="p-2">レシピ投稿</h1>
                </div>
              </div>
              <!-- レシピ名入力 -->
              <div class="row justify-content-center">
                <div class="col-md-8">
                  <div class="row justify-content-center text-center p-5">
                    <div class="col-md-3 ">
                      <h4>タイトル</h4>
                    </div>
                    <div class="col-md-9">
                      <input type="text" th:field="*{recipeName}" id="floatingInput" class="form-control" />
                    </div>
                  </div>
                </div>
              </div>
              <!-- イメージ -->
              <div class="row justify-content-center">
                <div class="col-md-8">
                  <div class="row justify-content-center text-center p-5">
                    <div class="col-md-3 ">
                      <h4>イメージ</h4>
                    </div>
                    <div class="col-md-9">
                      <input type="file" name="thumbFile" class="form-control" />
                    </div>
                  </div>
                </div>
              </div>
              <div class="row justify-content-center p-5">
                <div class="col-md-7">
                  <hr />
                </div>
              </div>
              <!-- 調理時間、カロリー、カテゴリ -->
              <div class="row justify-content-center text-center">
                <div class="col-md-2 form-group">
                  <label for="" class="p-2">
                    <h3>カテゴリ</h3>
                  </label>
                  <select class="form-select" th:field="*{category}" id="write_category">
                    <option value="韓国料理" selected>韓国料理</option>
                    <option value="日本料理">日本料理</option>
                    <option value="中華料理">中華料理</option>
                    <option value="西洋料理">西洋料理</option>
                  </select>
                </div>
                <div class="col-md-2 form-group">
                  <label for="" class="p-2">
                    <h3>調理時間</h3>
                  </label>
                  <div class="row justify-content-center">
                    <div class="col-md-auto">
                      <select class="form-select" th:field="*{cookTime}" id="write_cookTime">
                        <option value="10" selected>10分</option>
                        <option value="20">20分</option>
                        <option value="30">30分</option>
                        <option value="40">40分</option>
                        <option value="50">50分</option>
                        <option value="60">60分</option>
                        <option value="61">60分以上</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="col-md-2">
                  <label for="" class="p-2">
                    <h3>予算</h3>
                  </label>
                  <div class="col-md-auto">
                    <select class="form-select" th:field="*{budget}" id="write_budget">
                      <option value="100" selected>100円以内</option>
                      <option value="500">101~500円</option>
                      <option value="1000">501~1000円</option>
                      <option value="2000">1000~2000円</option>
                      <option value="5000">2000~5000円</option>
                      <option value="5001">5000円以上</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="row justify-content-center p-5">
                <div class="col-md-7">
                  <hr />
                </div>
              </div>
              <!-- 材料登録 -->
              <div class="row justify-content-center text-center" id="recipe_info">
                <label for="">
                  <h1 class="p-2">材料</h1>
                </label>

                <!-- Modal -->
                <div class="modal fade" id="staticBackdrop" tabindex="-1" aria-labelledby="staticBackdrop" aria-hidden="true">
                  <div class="modal-dialog " style="width: 800px;">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="staticBackdrop">材料</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">

                        <div class="row">
                          <div class="col-md-6">
                            <div class="mb-3">
                              <label for="main-category-dropdown" class="form-label">メインカテゴリー</label>
                              <select class="form-select" id="main-category-dropdown" name="mainCategoryId" >
                                <option value="">選択してください</option>
                                <option th:each="mainCategory : ${mainCategories}"
                                        th:value="${mainCategory.parent.id}"
                                        th:text="${mainCategory.name}" ></option>
                              </select>
                            </div>
                            <div class="mb-3">
                              <label for="sub-category-dropdown" class="form-label">詳細カテゴリー</label>
                              <select class="form-select" id="sub-category-dropdown" name="subCategoryId" >
                                <option value="">選択してください</option>
                              </select>
                            </div>

                            <div class="mb-3">
                              <label for="ingredient-dropdown" class="form-label">材料</label>
                              <select class="form-select" id="ingredient-dropdown" name="name" >
                                <option value="">選択してください</option>
                              </select>
                            </div>

                            <div class="mb-3">
                              <label for="qty-dropdown" class="form-label">計量</label>
                              <select class="form-select" id="qty-dropdown" name="measurementUnitId" >
                                <option value="" selected>選択してください</option>
                                <option value="direct">直接入力する</option>
                                <option>1/2</option>
                                <option>1/3</option>
                                <option>2/3</option>
                                <option>1</option>
                                <option>10</option>
                                <option>100</option>
                              </select>
                              <input type="text" id="unitDirect" name="unitDirect"/>
                            </div>
                            <div class="mb-3">
                              <label for="unit-dropdown" class="form-label">単位</label>
                              <select class="form-select" id="unit-dropdown" name="measurementUnitId" >
                                <option value="">選択してください</option>
                                <option th:each="unit : ${units}"
                                        th:value="${unit.id}"
                                        th:text="${unit.name}"
                                ></option>
                              </select>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                              <button type="submit" class="btn btn-primary">追加</button>
                            </div>
                          </div>
                          <!-- 追加された材料リスト -->
                          <div class="col-md-6">
                            <form method="post" th:action="@{/ingredient/search}" >
                              <div class="mb-3">
                                <table class="table-ing">
                                  <tr>
                                    <td class="table-ing-title" colspan="3">選択された材料</td>
                                  </tr>
                                  <tr>
                                    <td>------</td>
                                  </tr>
                                  <tr>
                                    <td>サーロイン(牛, 肉類)</td>
                                    <td class="table-ing-qty">100</td>
                                    <td class="table-ing-unit">g</td>
                                    <td class="table-ing-unit"><button class="">X</button></td>
                                  </tr>
                                  <tr>
                                    <td>ヒレ(豚, 肉類)</td>
                                    <td class="table-ing-qty">100</td>
                                    <td class="table-ing-unit">g</td>
                                    <td class="table-ing-unit"><button class="">X</button></td>
                                  </tr>
                                </table>
                              </div>

                              <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">保存</button>
                              </div>
                            </form>
                          </div>

                        </div>

                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 text-center">
                  <div class="">

                    <!-- Modal ボタン -->
                    <div class="modal-div">
                      <button type="button" class="btn modal-ing" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                        クリックして材料をのせる
                      </button>
                    </div>

                </div>
              </div>
              <div class="row justify-content-center p-5">
                <div class="col-md-7">
                  <hr />
                </div>
              </div>
              <!-- 作り方登録 -->
              <div class="row justify-content-center text-center">
                <div class="col-md-6">
                  <label class="" for="">
                    <h1>作り方</h1>
                  </label>
                  <div class="row justify-content-center">
                    <label for="" class="p-2 text-start">1番目</label>
                    <div class="col-md-8 p-2">
                      <textarea
                        class="form-control"
                        name="instruction"
                        id="instructions"
                        rows="5"
                        placeholder="作り方を入力"
                      ></textarea>
                    </div>
                    <div class="col-md-4">
                      <label for="">イメージ登録</label>
                      <input
                        type="image"
                        class="form-control"
                        src=""
                      />
                      <input type="file" class="form-control" />
                    </div>
                  </div>
                  <div class="row justify-content-center">
                    <label for="" class="p-2 text-start">2番目</label>
                    <div class="col-md-8 p-2">
                      <textarea
                        class="form-control"
                        id="instructions"
                        rows="5"
                        placeholder="作り方を入力"
                      ></textarea>
                    </div>
                    <div class="col-md-4">
                      <label for="">イメージ</label>
                      <input
                        type="image"
                        class="form-control"
                        src=""
                      />
                      <input type="file" class="form-control" />
                    </div>
                  </div>
                  <div class="row text-start">
                    <div class="col-md-3 text-start">
                      <button type="button" class="btn btn-secondary">
                        調理法追加
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row justify-content-center p-5">
                <div class="col-md-7">
                  <hr />
                </div>
              </div>
              <!-- YouTube登録 -->
              <div class="row justify-content-center">
                <label class="text-center" for="">
                  <h1>YouTube動画</h1>
                </label>
                <div class="col-md-6">
                  <iframe
                    class="container-fluid"
                    width="560"
                    height="315"
                    src="https://www.youtube.com/embed/OJN3KIGxnpk"
                    title="YouTube video player"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    allowfullscreen
                  ></iframe>
                  <div class="row p-3">
                    <div class="col-md-3">
                      <h3 class="text-center">動画リンク :</h3>
                    </div>
                    <div class="col-md-8">
                      <input
                        type="text"
                        class="form-control"
                        placeholder="URL入力"
                      />
                    </div>
                  </div>
                </div>
              </div>

              <div class="row justify-content-center p-5">
                <div class="col-md-7">
                  <hr />
                </div>
              </div>
              <div class="row justify-content-center">
                <button type="submit" class="btn btn-secondary col col-md-1">
                  投稿
                </button>
              </div>

              <div class="row p-5"></div>
            </form>
          </div>
          <div class="col-md-2"></div>
        </div>
      </div>
    </main>
    <footer class="bg-light mt-3 p-3 text-center">
      <p>Recipe Management Site &copy; 2023</p>
    </footer>
  </div>
  <script layout:fragment="script" type='text/javascript'>
var token = $("meta[name='_csrf']").attr("content");
  var header = $("meta[name='_csrf_header']").attr("content");
  $(document).ajaxSend(function(e, xhr, options) { xhr.setRequestHeader(header, token); });

// 直接入力
$(function(){
  $("#unitDirect").hide(); // Input Hidden
  $("#unit-dropdown").change(function() {
      if($("#unit-dropdown").val() == "direct") { // 入力をセレクトすると、
          $("#unitDirect").show(); // Input Display
      }  else {
          $("#unitDirect").hide(); // Input Hidden
      }
    })
});

// 詳細カテゴリー
$(document).ready(function() {
    $("#main-category-dropdown").change(function() {
        var parentId = $(this).val();
        $.ajax({
            type: "POST",
            url: "/ingredient/sub",
            data: { parentId: parentId },
            dataType: "json",
            success: function(response) {

                // 詳細カテゴリーをリセット
                $("#sub-category-dropdown").empty();

                // メインカテゴリーを選えらび直すと → 以下のリストリセット
                var option = $("<option>").text("選択してください").attr("value", "");

                $("#ingredient-dropdown").empty();
                $("#ingredient-dropdown").append($("<option>").text("選択してください").attr("value", ""));

                  $(function() {
                    $("#unitDirect").hide(); // Input Hidden
                    $("#qty-dropdown").change(function() {
                      if ($("#qty-dropdown").val() == "direct") {
                        $("#unitDirect").show(); // Input Display
                      } else {
                        $("#unitDirect").hide(); // Input Hidden
                      }
                    });
                    $("#qty-dropdown option:first").prop("selected", true);
                  });

                $("#unit-dropdown option:first").prop("selected", true);

                // 詳細カテゴリーをリストに入れる
                $.each(response, function(index, subcategory) {

                    // 詳細カテゴリーがメインカテゴリーと一緒
                    if(subcategory.level == 0 && index == 0) {
                      var option = $("<option>").text("-").attr("value", subcategory.id);
                      $("#sub-category-dropdown").append(option);
                    }

                    // 「選択してください」を入れる
                    if(subcategory.level == 1 && index == 0) {
                      var option = $("<option>").text("選択してください").attr("value", subcategory.id);
                      $("#sub-category-dropdown").append(option);
                    }

                    // 詳細カテゴリーを出力
                    if(subcategory.level == 1) {
                    var option = $("<option>").text(subcategory.name).attr("value", subcategory.id);
                    $("#sub-category-dropdown").append(option);
                    }
                });
            },
            error: function(xhr, textStatus, errorThrown) {
                console.log("Error: " + errorThrown);
            }
        });
    });
});

$(document).ready(function() {
    $("#sub-category-dropdown").change(function() {
        var categoryId = $(this).val();
        console.log("categoryId: " + categoryId);
        $.ajax({
            type: "POST",
            url: "/ingredient/ing",
            data: { categoryId: categoryId },
            dataType: "json",
            success: function(response) {

                // 材料リストをリセット
                $("#ingredient-dropdown").empty();

                // 詳細カテゴリーを選えらび直すと → 以下のリストリセット
                var option = $("<option>").text("選択してください").attr("value", "");
                  $(function() {
                    $("#unitDirect").hide(); // Input Hidden
                    $("#qty-dropdown").change(function() {
                      if ($("#qty-dropdown").val() == "direct") {
                        $("#unitDirect").show(); // Input Display
                      } else {
                        $("#unitDirect").hide(); // Input Hidden
                      }
                    });
                    $("#qty-dropdown option:first").prop("selected", true);
                  });

                $("#unit-dropdown option:first").prop("selected", true);

                // 材料をリストに入れる
                $.each(response, function(index, ingredient) {

                    // 「選択してください」を入れる
                    if(index == 0) {
                      var option = $("<option>").text("選択してください").attr("value", ingredient.id);
                      $("#ingredient-dropdown").append(option);
                    } else { // 材料を出力
                    var option = $("<option>").text(ingredient.name).attr("value", ingredient.id);
                    $("#ingredient-dropdown").append(option);
                    }
                });
            },
            error: function(xhr, textStatus, errorThrown) {
                console.log("Error: " + errorThrown);
            }
        });
    });
});

// 材料を選えらび直すと → 以下のリストリセット
$(document).ready(function() {
    $("#ingredient-dropdown").change(function() {
      $(function() {
        $("#unitDirect").hide(); // Input Hidden
        $("#qty-dropdown").change(function() {
          if ($("#qty-dropdown").val() == "direct") {
            $("#unitDirect").show(); // Input Display
          } else {
            $("#unitDirect").hide(); // Input Hidden
          }
        });
        $("#qty-dropdown option:first").prop("selected", true);
      });

    $("#unit-dropdown option:first").prop("selected", true);

    });
});

  </script>
</html>
