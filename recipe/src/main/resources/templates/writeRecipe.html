<html layout:decorate="~{layout}">
<div layout:fragment="content">
  <link rel="stylesheet" type="text/css" th:href="@{/css/writeRecipe.css}" />
  <header th:replace="~{header :: headerFragment}"></header>
  <main>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-2"></div>
        <div class="col-md-auto">
          <div class="mt-5">
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item">&nbsp;&nbsp;&nbsp;<a th:href="@{/index}">ホーム</a></li>
                <li class="breadcrumb-item active" aria-current="page">レシピ投稿</li>
              </ol>
            </nav>
          </div>
          <form th:object="${recipeForm}" method="post" id='writeForm' enctype="multipart/form-data" novalidate>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div class="alert alert-danger" role="alert" th:if="${#fields.hasAnyErrors()}">
              <div th:each="err : ${#fields.allErrors()}" th:text="${err}"></div>
            </div>
            <div class="row justify-content-center p-5">
              <div class="text-center" id="">
                <h1 class="p-2">レシピを書く</h1>
                <h6>あなたの家の定番の味、工夫やアイデアをレシピとして記録しよう</h6>
              </div>
            </div>
            <!-- レシピ名入力 -->
            <div class="row justify-content-center">
              <div class="col-md-8">
                <div class="row justify-content-center text-center p-5">
                  <div class="col-md-8">
                    <h2>レシピのタイトル</h2>
                    <div class="input-title">
                      <input type="text" th:field="*{recipeName}" id="floatingInput" class="form-control" />
                    </div>
                    <h6>
                      レシピに合ったタイトルをつけてください。
                    </h6>
                  </div>
                </div>
              </div>
            </div>
            <!--  区切り線 -->
            <div class="row justify-content-center p-5">
              <div class="col-md-7">
                <hr />
              </div>
            </div>
            <!-- イメージ登録 -->
            <div class="row justify-content-center">
              <div class="col-md-8">
                <div class="row justify-content-center text-center">
                  <div class="col-md-8">
                    <h2>レシピの写真</h2>
                    <label class="label" id="label" for="input" th:attr="data-thumbnail=${recipeForm.thumbnail}">
                      <!-- Drag N Drop Icon -->
                      <div class="inner" id="inner">
                        <!-- イメージ preview-->
                        <div class="preview" id="preview">
                          <img class="preview" th:if="${recipeForm.thumbnail}"
                            th:src="@{|/uploaded/${recipeForm.thumbnail}|}" />
                        </div>
                        <img th:src="@{/assets/icon/dragndrop.png}" class="dragicon" alt=""
                          th:classappend="${recipeForm.thumbnail} ? 'hidden' : ''">
                      </div>
                    </label>

                    <!-- イメージファイル thumbFile-->
                    <input id="input" class="input" accept="image/*" type="file" name="thumbFile" required="true"
                      multiple="true" hidden="true" onchange="handleUpdate(event)"
                      th:attr="data-thumbnail=${recipeForm.thumbnail}">
                    <h5>ドラッグ＆ドロップで登録</h5>
                  </div>
                </div>
              </div>
            </div>


            <!--  区切り線 -->
            <div class="row justify-content-center p-5">
              <div class="col-md-7">
                <hr />
              </div>
            </div>
            <!-- カテゴリ、調理時間、予算 -->
            <div class="row justify-content-center text-center">
              <!-- カテゴリ -->
              <div class="col-md-2 form-group">
                <label for="" class="p-2">
                  <h3>カテゴリ</h3>
                </label>
                <select class="form-select" th:field="*{category}" id="write_category">
                  <option value="韓国料理" selected>韓国料理</option>
                  <option value="日本料理">日本料理</option>
                  <option value="中華料理">中華料理</option>
                  <option value="西洋料理">西洋料理</option>
                </select>
              </div>
              <!-- 調理時間 -->
              <div class="col-md-2 form-group">
                <label for="" class="p-2">
                  <h3>調理時間</h3>
                </label>
                <div class="row justify-content-center">
                  <div class="col-md-auto">
                    <select class="form-select" th:field="*{cookTime}" id="write_cookTime">
                      <option value="10" selected>10分</option>
                      <option value="20">20分</option>
                      <option value="30">30分</option>
                      <option value="40">40分</option>
                      <option value="50">50分</option>
                      <option value="60">60分</option>
                      <option value="61">60分以上</option>
                    </select>
                  </div>
                </div>
              </div>
              <!-- 予算 -->
              <div class="col-md-2">
                <label for="" class="p-2">
                  <h3>予算</h3>
                </label>
                <div class="col-md-auto">
                  <select class="form-select" th:field="*{budget}" id="write_budget">
                    <option value="100" selected>100円以内</option>
                    <option value="500">101~500円</option>
                    <option value="1000">501~1000円</option>
                    <option value="2000">1000~2000円</option>
                    <option value="5000">2000~5000円</option>
                    <option value="5001">5000円以上</option>
                  </select>
                </div>
              </div>
            </div>
            <!--  区切り線 -->
            <div class="row justify-content-center p-5" id="ing-tag">
              <div class="col-md-7">
                <hr />
              </div>
            </div>
            <!-- 材料登録 -->
            <div class="row justify-content-center text-center">
              <label for="">
                <h1 class="p-2">材料</h1>
              </label>
              <!-- Modal -->
              <div class="modal fade" id="staticBackdrop" tabindex="-1" aria-labelledby="staticBackdrop"
                aria-hidden="true">
                <div class="modal-dialog " style="width: 800px;">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="staticBackdrop">材料</h5>
                      <button type="button" class="btn-close" id="close-ingredient-modal" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div class="row">
                        <div class="col-md-6">
                          <!-- メインリスト -->
                          <div class="mb-3">
                            <label for="main-category-dropdown" class="form-label">メインカテゴリー</label>
                            <select class="form-select" id="main-category-dropdown" name="mainCategoryId">
                              <option value="">選択してください</option>
                            </select>
                          </div>
                          <!-- 詳細リスト -->
                          <div class="mb-3">
                            <label for="sub-category-dropdown" class="form-label">詳細カテゴリー</label>
                            <select class="form-select" id="sub-category-dropdown" name="subCategoryId">
                              <option value="">選択してください</option>
                            </select>
                          </div>
                          <!-- 材料リスト -->
                          <div class="mb-3">
                            <label for="ingredient-dropdown" class="form-label">材料</label>
                            <select class="form-select" id="ingredient-dropdown" name="name">
                              <option value="">選択してください</option>
                            </select>
                          </div>
                          <!-- 計量リスト -->
                          <div class="mb-3">
                            <label for="qty-dropdown" class="form-label">計量</label>
                            <select class="form-select" id="qty-dropdown" name="measurementUnitId">
                              <option value="" selected>選択してください</option>
                              <option value="direct">直接入力する</option>
                              <option value="1/2">1/2</option>
                              <option value="1/3">1/3</option>
                              <option value="2/3">2/3</option>
                              <option value="1">1</option>
                              <option value="10">10</option>
                              <option value="100">100</option>
                            </select>
                            <input type="text" id="qtyDirect" name="qtyDirect" class="form-control" />
                          </div>
                          <!-- 単位リスト -->
                          <div class="mb-3">
                            <label for="unit-dropdown" class="form-label">単位</label>
                            <select class="form-select" id="unit-dropdown" name="measurementUnitId">
                              <option value="">選択してください</option>
                            </select>
                          </div>
                          <!--  Modal　Footer 1. 追加 -->
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="reset-button">取消</button>
                            <button type="button" class="btn btn-primary" id="add-button">追加</button>
                          </div>
                        </div>
                        <!-- 追加された材料リスト -->
                        <div class="col-md-6">
                          <form method="post" th:action="@{/ingredient/search}">
                            <div class="mb-3">
                              <table class="table-ing container">
                                <thead>
                                  <tr>
                                    <th class="table-ing-title" colspan="3">選択された材料</th>
                                  </tr>
                                </thead>
                                <tbody id="selected-items">
                                </tbody>
                              </table>
                            </div>
                            <!--  Modal　Footer 2. 保存 -->
                            <div class="modal-footer">
                              <button type="button" class="btn btn-primary" id="save-button">保存</button>
                            </div>
                          </form>
                        </div><!-- 追加された材料リスト End -->
                      </div>
                    </div><!-- Modal Body End -->
                  </div><!-- Modal Content End -->
                </div><!-- Modal Dialog End -->
              </div><!-- Modal End -->
              <div class="col-md-6 text-center">
                <!-- Modal Button -->
                <div class="modal-div">
                  <button type="button" class="btn modal-ing" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                    <span class="modal-ing-content">クリックして材料をのせる</span>
                    <div>
                    </div>
                    <table class="table">
                      <thead>
                        <tr>
                          <th scope="col"></th>
                          <th scope="col">材料名</th>
                          <th scope="col">数量</th>
                          <th scope="col">計量単位</th>
                        </tr>
                      </thead>
                      <tbody class="display-items"></tbody>
                      <tbody id="riListTable" class="display-riList" th:if="${not #lists.isEmpty(riList)}">
                        <tr th:each="ing, loop : ${riList}">
                          <th scope="row"></th>
                          <td th:text="${ing.ingredient.name}"></td>
                          <td th:text="${ing.quantity}"></td>
                          <td th:text="${ing.measurementUnit.name}"></td>
                        </tr>
                      </tbody>
                    </table>
                  </button>
                </div>
              </div>

              <!--  区切り線 -->
              <div class="row justify-content-center p-5">
                <div class="col-md-7">
                  <hr />
                </div>
              </div>
              <!-- 作り方登録 : subFile -->
              <div class="row justify-content-center text-center" th:object="${instructionForm}">
                <div class="col-md-6">
                  <label class="" for="">
                    <h1>作り方</h1>
                  </label>
                  <div th:if="${not #lists.isEmpty(istList)}">
                    <div class="row justify-content-center" th:each="ist, loop : ${istList}">
                      <label for="" class="p-2 text-start">1番目</label>
                      <div class="col-md-8 p-2">
                        <textarea class="form-control" name="description" id="instructions" rows="5"
                          th:text="${ist.description}"></textarea>
                      </div>
                      <div class="col-md-4">
                        <label class="label" id="label" for="input">
                          <!-- Drag N Drop Icon -->
                          <div class="inner" id="inner">
                            <img th:src="@{/assets/icon/dragndrop.png}" class="dragicon" alt=""
                              th:if="${ist.imgUrl == null}">
                            <!-- イメージ preview-->
                            <div class="preview" id="preview1"></div>
                          </div>
                        </label>
                        <input type="file" name="imgUrl" id="" th:if="${ist.imgUrl == null}">
                        <img th:src="@{|\uploaded\${ist.imgUrl}|}" alt="Image preview" th:if="${ist.imgUrl != null}"
                          id="img-preview">
                      </div>
                    </div>
                  </div>
                  <div th:if="${#lists.isEmpty(istList)}">

                    <div class="row justify-content-center" id="section1">
                      <div class="d-flex align-items-center">
                        <label for="" class="p-2 text-start section-label">1番目</label>
                      </div>
                      <div class="col-md-8 p-2">
                        <textarea class="form-control" name="description" id="instructions" rows="5"
                          placeholder="作り方を入力"></textarea>
                      </div>
                      <div class="col-md-4">
                        <label class="label2" for="input2_1">
                          <div class="inner2">
                            <img src="/assets/icon/dragndrop.png" class="dragicon2_1" alt="">
                            <div class="preview2" id="preview2_1"></div>
                          </div>
                        </label>
                        <input id="input2_1" class="input2" accept="image/*" type="file" name="imgUrl"
                          required="true" multiple="true" hidden="true" data-section-id="1">
                      </div>
                    </div>

                    <!-- 1番目 -->
                    <!-- <div class="row justify-content-center">
                      <label for="" class="p-2 text-start">1番目</label>
                      <div class="col-md-8 p-2">
                        <textarea class="form-control" name="description" id="instructions" rows="5"
                          placeholder="作り方を入力"></textarea>
                      </div>
                      <div class="col-md-4">
                        <label class="label2" id="label2" for="input">
                          <div class="inner2" id="inner2">
                            <img th:src="@{/assets/icon/dragndrop.png}" class="dragicon" alt="">
                            <div class="preview2" id="preview2"></div>
                          </div>
                        </label>
                        <input id="input2" class="input2" accept="image/*" type="file" name="imgUrl" required="true"
                          multiple="true" hidden="true">
                        <button type="button" class="btn btn-danger delete-section-btn" style="display: none;">
                          削除
                        </button>
                      </div>
                    </div> -->

                    <!-- 動的に追加される節の場所 -->
                    <div id="dynamic-section"></div>

                    <!-- 追加 Button -->
                    <div class="row text-start">
                      <div class="col-md-3 text-start">
                        <button type="button" class="btn btn-secondary" id="add-section-btn">
                          追加
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!--  区切り線 -->
              <div class="row justify-content-center p-5">
                <div class="col-md-7">
                  <hr />
                </div>
              </div>
              <!-- YouTube登録 -->
              <div class="row justify-content-center">
                <label class="text-center" for="">
                  <h1>YouTube動画</h1>
                </label>
                <div class="col-md-6">
                  <div class="row p-3">
                    <div class="col-md-4">
                      <h3 class="text-center">動画リンク :</h3>
                    </div>
                    <div class="col-md-8">
                      <input type="text" id="video-url" class="form-control" th:field="*{videoUrl}"
                        placeholder="URL入力" />
                    </div>

                  </div>
                  <div class="row mt-3">
                    <div class="col-md-12">
                      <div id="video-preview" style="display: none;">
                        <h3>動画プレビュー</h3>
                        <iframe id="video-iframe" width="560" height="315" src="" frameborder="0"
                          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                          allowfullscreen></iframe>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!--  区切り線 -->
              <div class="row justify-content-center p-5">
                <div class="col-md-7">
                  <hr />
                </div>
              </div>
              <!--  投稿 button -->
              <div class="row justify-content-center">
                <button type="submit" class="btn btn-secondary col col-md-1">
                  投稿
                </button>
              </div>
              <div class="row p-5"></div>
              <input type="hidden" id="send-list-input" name="sendList">
              <input type="hidden" id="recipeId" th:field="*{id}">
            </div>
          </form>
        </div>
        <div class="col-md-2"></div>
      </div>
    </div>
  </main>
  <footer th:replace="~{footer :: footerFragment}"></footer>
  <script layout:fragment="script" type="text/javascript" th:src="@{/js/writeRecipe.js}"></script>
</div>

<script layout:fragment="script" type='text/javascript'>
  /* 動画挿入 */
  function extractVideoIdFromUrl(url) {
    const pattern = /(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([\w-]{11})(?:.+)?$/;
    const match = url.match(pattern);
    return match ? match[1] : null;
  }

  function showVideoPreview() {
    const videoUrlInput = document.getElementById('video-url');
    const videoPreviewContainer = document.getElementById('video-preview');
    const videoIframe = document.getElementById('video-iframe');

    videoUrlInput.addEventListener('input', () => {
      const videoUrl = videoUrlInput.value;
      const videoId = extractVideoIdFromUrl(videoUrl);

      if (videoId) {
        videoPreviewContainer.style.display = 'block';
        videoIframe.src = `https://www.youtube.com/embed/${videoId}`;
      } else {
        videoPreviewContainer.style.display = 'none';
        videoIframe.src = '';
      }
    });

    // ページ読み込み時に入力欄に既に動画URLがあれば、プレビューを更新する
    const existingVideoUrl = videoUrlInput.value;

    // 入力欄に値が入力されたときにプレビューを更新する
    updateVideoPreview(existingVideoUrl);

    function updateVideoPreview(videoUrl) {
      const videoId = extractVideoIdFromUrl(videoUrl);

      if (videoId) {
        // 動画IDが抽出できた場合、プレビューを表示する
        videoPreviewContainer.style.display = 'block';
        videoIframe.src = `https://www.youtube.com/embed/${videoId}`;
      } else {
        // 動画IDが抽出できなかった場合、プレビューを非表示にする
        videoPreviewContainer.style.display = 'none';
        videoIframe.src = '';
      }
    }
  }

  // showVideoPreview()関数を実行して、プレビューを表示する
  showVideoPreview();





</script>

</html>