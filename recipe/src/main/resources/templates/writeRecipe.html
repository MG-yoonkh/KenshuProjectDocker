<html layout:decorate="~{layout}">
<div layout:fragment="content">
  <link rel="stylesheet" type="text/css" th:href="@{/css/writeRecipe.css}" />
  <header th:replace="~{header :: headerFragment}"></header>
  <main>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-2"></div>
        <div class="col-md-auto">
          <form th:object="${recipeForm}" method="post" id='writeForm' enctype="multipart/form-data" novalidate>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div class="alert alert-danger" role="alert" th:if="${#fields.hasAnyErrors()}">
              <div th:each="err : ${#fields.allErrors()}" th:text="${err}"></div>
            </div>
            <div class="row justify-content-center p-5">
              <div class="text-center" id="">
                <h1 class="p-2">レシピを書く</h1>
                <h6>あなたの家の定番の味、工夫やアイデアをレシピとして記録しよう</h6>
              </div>
            </div>
            <!-- レシピ名入力 -->
            <div class="row justify-content-center">
              <div class="col-md-8">
                <div class="row justify-content-center text-center p-5">
                  <div class="col-md-8">
                    <h2>レシピのタイトル</h2>
                    <div class="input-title">
                      <input type="text" th:field="*{recipeName}" id="floatingInput" class="form-control" />
                    </div>
                    <h6>
                      レシピに合ったタイトルをつけてください。
                    </h6>
                  </div>
                </div>
              </div>
            </div>
            <!--  区切り線 -->
            <div class="row justify-content-center p-5">
              <div class="col-md-7">
                <hr />
              </div>
            </div>
            <!-- イメージ登録 -->
            <div class="row justify-content-center">
              <div class="col-md-8">
                <div class="row justify-content-center text-center">
                  <div class="col-md-8">
                    <h2>レシピの写真</h2>
                    <label class="label" id="label" for="input">
                      <!-- Drag N Drop Icon -->
                      <div class="inner" id="inner">
                        <!-- イメージ preview-->
                        <div class="preview" id="preview"></div>
                        <img th:src="@{/assets/icon/dragndrop.png}" class="dragicon" alt="">
                      </div>
                    </label>
                    <!-- イメージファイル thumbFile-->
                    <input id="input" class="input" accept="image/*" type="file" name="thumbFile" required="true"
                      multiple="true" hidden="true">
                    <h5>ドラッグ＆ドロップで登録</h5>

                  </div>
                </div>
              </div>
            </div>
            <!--  区切り線 -->
            <div class="row justify-content-center p-5">
              <div class="col-md-7">
                <hr />
              </div>
            </div>
            <!-- カテゴリ、調理時間、予算 -->
            <div class="row justify-content-center text-center">
              <!-- カテゴリ -->
              <div class="col-md-2 form-group">
                <label for="" class="p-2">
                  <h3>カテゴリ</h3>
                </label>
                <select class="form-select" th:field="*{category}" id="write_category">
                  <option value="韓国料理" selected>韓国料理</option>
                  <option value="日本料理">日本料理</option>
                  <option value="中華料理">中華料理</option>
                  <option value="西洋料理">西洋料理</option>
                </select>
              </div>
              <!-- 調理時間 -->
              <div class="col-md-2 form-group">
                <label for="" class="p-2">
                  <h3>調理時間</h3>
                </label>
                <div class="row justify-content-center">
                  <div class="col-md-auto">
                    <select class="form-select" th:field="*{cookTime}" id="write_cookTime">
                      <option value="10" selected>10分</option>
                      <option value="20">20分</option>
                      <option value="30">30分</option>
                      <option value="40">40分</option>
                      <option value="50">50分</option>
                      <option value="60">60分</option>
                      <option value="61">60分以上</option>
                    </select>
                  </div>
                </div>
              </div>
              <!-- 予算 -->
              <div class="col-md-2">
                <label for="" class="p-2">
                  <h3>予算</h3>
                </label>
                <div class="col-md-auto">
                  <select class="form-select" th:field="*{budget}" id="write_budget">
                    <option value="100" selected>100円以内</option>
                    <option value="500">101~500円</option>
                    <option value="1000">501~1000円</option>
                    <option value="2000">1000~2000円</option>
                    <option value="5000">2000~5000円</option>
                    <option value="5001">5000円以上</option>
                  </select>
                </div>
              </div>
            </div>
            <!--  区切り線 -->
            <div class="row justify-content-center p-5">
              <div class="col-md-7">
                <hr />
              </div>
            </div>
            <!-- 材料登録 -->
            <div class="row justify-content-center text-center" id="recipe_info">
              <label for="">
                <h1 class="p-2">材料</h1>
              </label>
              <!-- Modal -->
              <div class="modal fade" id="staticBackdrop" tabindex="-1" aria-labelledby="staticBackdrop"
                aria-hidden="true">
                <div class="modal-dialog " style="width: 800px;">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="staticBackdrop">材料</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div class="row">
                        <div class="col-md-6">
                          <!-- メインリスト -->
                          <div class="mb-3">
                            <label for="main-category-dropdown" class="form-label">メインカテゴリー</label>
                            <select class="form-select" id="main-category-dropdown" name="mainCategoryId">
                              <option value="">選択してください</option>

                            </select>
                          </div>
                          <!-- 詳細リスト -->
                          <div class="mb-3">
                            <label for="sub-category-dropdown" class="form-label">詳細カテゴリー</label>
                            <select class="form-select" id="sub-category-dropdown" name="subCategoryId">
                              <option value="">選択してください</option>
                            </select>
                          </div>
                          <!-- 材料リスト -->
                          <div class="mb-3">
                            <label for="ingredient-dropdown" class="form-label">材料</label>
                            <select class="form-select" id="ingredient-dropdown" name="name">
                              <option value="">選択してください</option>
                            </select>
                          </div>
                          <!-- 計量リスト -->
                          <div class="mb-3">
                            <label for="qty-dropdown" class="form-label">計量</label>
                            <select class="form-select" id="qty-dropdown" name="measurementUnitId">
                              <option value="" selected>選択してください</option>
                              <option value="direct">直接入力する</option>
                              <option value="1/2">1/2</option>
                              <option value="1/3">1/3</option>
                              <option value="2/3">2/3</option>
                              <option value="1">1</option>
                              <option value="10">10</option>
                              <option value="100">100</option>
                            </select>
                            <input type="text" id="qtyDirect" name="qtyDirect" />
                          </div>
                          <!-- 単位リスト -->
                          <div class="mb-3">
                            <label for="unit-dropdown" class="form-label">単位</label>
                            <select class="form-select" id="unit-dropdown" name="measurementUnitId">
                              <option value="">選択してください</option>
                            </select>
                          </div>
                          <!--  Modal　Footer 1. 追加 -->
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" id="add-button">追加</button>
                          </div>
                        </div>
                        <!-- 追加された材料リスト -->
                        <div class="col-md-6">
                          <form method="post" th:action="@{/ingredient/search}">
                            <div class="mb-3">
                              <table class="table-ing container">
                                <thead>
                                  <tr>
                                    <th class="table-ing-title" colspan="3">選択された材料</th>
                                  </tr>
                                </thead>
                                <tbody id="selected-items">
                                </tbody>
                              </table>
                            </div>
                            <!--  Modal　Footer 2. 保存 -->
                            <div class="modal-footer">
                              <button type="button" class="btn btn-primary" id="save-button">保存</button>
                            </div>
                          </form>
                        </div><!-- 追加された材料リスト End -->
                      </div>
                    </div><!-- Modal Body End -->
                  </div><!-- Modal Content End -->
                </div><!-- Modal Dialog End -->
              </div><!-- Modal End -->
              <table class="table-ing container">
                <thead>
                </thead>
                <tbody id="selected-items">
                </tbody>
              </table>


              <div class="col-md-6 text-center">
                <!-- Modal Button -->
                <div class="modal-div">
                  <button type="button" class="btn modal-ing" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                    クリックして材料をのせる
                  </button>
                </div>
              </div>
              <!--  区切り線 -->
              <div class="row justify-content-center p-5">
                <div class="col-md-7">
                  <hr />
                </div>
              </div>
              <!-- 作り方登録 : subFile -->
              <div class="row justify-content-center text-center" th:object="${instructionForm}">
                <div class="col-md-6">
                  <label class="" for="">
                    <h1>作り方</h1>
                  </label>
                  <!-- 1番目 -->
                  <div class="row justify-content-center">
                    <label for="" class="p-2 text-start">1番目</label>
                    <div class="col-md-8 p-2">
                      <textarea class="form-control" name="description" id="instructions" rows="5"
                        placeholder="作り方を入力"></textarea>
                    </div>
                    <div class="col-md-4">
                      <label class="label" id="label" for="input">
                        <!-- Drag N Drop Icon -->
                        <div class="inner" id="inner">
                          <img th:src="@{/assets/icon/dragndrop.png}" class="dragicon" alt="">
                          <!-- イメージ preview-->
                          <div class="preview" id="preview1"></div>
                        </div>
                      </label>
                      <!-- イメージファイル thumbFile-->
                      <!-- <input id="input" class="input" accept="image/*" type="file" name="imgUrl1" required="true"
                        multiple="true" hidden="true"> -->
                      <input type="file" name="imgUrl" id="">
                    </div>
                  </div>
                  <!-- 2番目 -->
                  <div class="row justify-content-center">
                    <label for="" class="p-2 text-start">1番目</label>
                    <div class="col-md-8 p-2">
                      <textarea class="form-control" name="description" id="instructions" rows="5"
                        placeholder="作り方を入力"></textarea>
                    </div>
                    <div class="col-md-4">
                      <label class="label" id="label" for="input">
                        <!-- Drag N Drop Icon -->
                        <div class="inner" id="inner">
                          <img th:src="@{/assets/icon/dragndrop.png}" class="dragicon" alt="">
                          <!-- イメージ preview-->
                          <div class="preview" id="preview2"></div>
                        </div>
                      </label>
                      <!-- イメージファイル thumbFile-->
                      <!-- <input id="input" class="input" accept="image/*" type="file" name="imgUrl2" required="true"
                        multiple="true" hidden="true"> -->
                      <input type="file" name="imgUrl" id="">
                    </div>
                  </div>
                  <!-- 3番目 -->
                  <div class="row justify-content-center">
                    <label for="" class="p-2 text-start">1番目</label>
                    <div class="col-md-8 p-2">
                      <textarea class="form-control" name="description" id="instructions" rows="5"
                        placeholder="作り方を入力"></textarea>
                    </div>
                    <div class="col-md-4">
                      <label class="label" id="label" for="input">
                        <!-- Drag N Drop Icon -->
                        <div class="inner" id="inner">
                          <img th:src="@{/assets/icon/dragndrop.png}" class="dragicon" alt="">
                          <!-- イメージ preview-->
                          <div class="preview" id="preview3"></div>
                        </div>
                      </label>
                      <!-- イメージファイル File-->
                      <!-- <input accept="image/*" type="file" name="imgUrl3" required="true"
                        multiple="true" hidden="true"> -->
                      <input type="file" name="imgUrl" id="">
                    </div>
                  </div>
                  <!-- 追加 Button -->
                  <div class="row text-start">
                    <div class="col-md-3 text-start">
                      <button type="button" class="btn btn-secondary">
                        追加
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <!--  区切り線 -->
              <div class="row justify-content-center p-5">
                <div class="col-md-7">
                  <hr />
                </div>
              </div>
              <!-- YouTube登録 -->
              <div class="row justify-content-center">
                <label class="text-center" for="">
                  <h1>YouTube動画</h1>
                </label>
                <div class="col-md-6">
                  <iframe class="container-fluid" width="560" height="315"
                    src="https://www.youtube.com/embed/OJN3KIGxnpk" title="YouTube video player" frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    allowfullscreen></iframe>
                  <div class="row p-3">
                    <div class="col-md-3">
                      <h3 class="text-center">動画リンク :</h3>
                    </div>
                    <div class="col-md-8">
                      <input type="text" class="form-control" placeholder="URL入力" />
                    </div>
                  </div>
                </div>
              </div>
              <!--  区切り線 -->
              <div class="row justify-content-center p-5">
                <div class="col-md-7">
                  <hr />
                </div>
              </div>
              <!--  投稿 button -->
              <div class="row justify-content-center">
                <button type="submit" class="btn btn-secondary col col-md-1">
                  投稿
                </button>
              </div>
              <div class="row p-5"></div>
              <input type="hidden" id="send-list-input" name="sendList">
          </form>
        </div>
        <div class="col-md-2"></div>
      </div>
    </div>
  </main>
  <footer class="bg-light mt-3 p-3 text-center">
    <p>Recipe Management Site &copy; 2023</p>
  </footer>
</div>
<script layout:fragment="script" type="text/javascript" th:src="@{/js/writeRecipe.js}"></script>
<script layout:fragment="script" type='text/javascript'>

  // Ajax 通信のため
  var token = $("meta[name='_csrf']").attr("content");
  var header = $("meta[name='_csrf_header']").attr("content");
  $(document).ajaxSend(function (e, xhr, options) { xhr.setRequestHeader(header, token); });

  // 直接入力
  $(function () {
    $("#qtyDirect").hide(); // Input Hidden
    $("#qty-dropdown").change(function () {
      if ($("#qty-dropdown").val() == "direct") { // 入力をセレクトすると、
        $("#qtyDirect").show(); // Input Display
      } else {
        $("#qtyDirect").hide(); // Input Hidden
      }
    })
  });

  // Modal Click
  $(document).ready(function () {

    document.querySelector(".modal-ing").addEventListener("click", function () {

      // 1. データ: mainCategory (DB)
      $.ajax({
        type: "GET",
        url: "/ingredient/main",
        dataType: "json",
        success: function (response) {

          // リセット
          $("#main-category-dropdown").empty();

          // 「選択してください」を入れる
          var option = $("<option>").text("選択してください").attr("value", "");
          $("#main-category-dropdown").append(option);
          // メインをリストに入れる
          $.each(response, function (index, main) {
            var option = $("<option>").text(main.name).attr("value", main.id);
            $("#main-category-dropdown").append(option);
          });

        },
        error: function (xhr, textStatus, errorThrown) {
          console.log("Error: " + errorThrown);
        }
      });

      // 2. データ: Unit (DB)
      $.ajax({
        type: "GET",
        url: "/ingredient/unit",
        dataType: "json",
        success: function (response) {

          // リセット
          $("#unit-dropdown").empty();

          // 「選択してください」を入れる
          var option = $("<option>").text("選択してください").attr("value", "");
          $("#unit-dropdown").append(option);

          // Unitを入れる
          $.each(response, function (index, unit) {
            var option = $("<option>").text(unit.name).attr("value", unit.id);
            $("#unit-dropdown").append(option);
          });

        },
        error: function (xhr, textStatus, errorThrown) {
          console.log("Error: " + errorThrown);
        }
      });

      //localStorage.clear();

      if (selectedItems.length > 0) {

        // 3. データ: savedList (Object)
        for (let i = 0; i < selectedItems.length; i++) {

          // selectedItems リセット
          $("#main-category-dropdown").empty();
          $("#sub-category-dropdown").empty();
          $("#ingredient-dropdown").empty();
          $("#unit-category-dropdown").empty();

          $("#main-category-dropdown").append($("<option>").text("選択してください").attr("value", ""));
          $("#sub-category-dropdown").append($("<option>").text("選択してください").attr("value", ""));
          $("#ingredient-dropdown").append($("<option>").text("選択してください").attr("value", ""));
          $("#unit-dropdown").append($("<option>").text("選択してください").attr("value", ""));

          $(function () {
            $("#qtyDirect").hide(); // Input Hidden
            $("#qty-dropdown").change(function () {
              if ($("#qty-dropdown").val() == "direct") {
                $("#qtyDirect").show(); // Input Display
              } else {
                $("#qtyDirect").hide(); // Input Hidden
              }
            });
            $("#qty-dropdown option:first").prop("selected", true);
          });

          selectedItems = [];
          //localStorage.clear();
          const key = localStorage.key(i);
          const value = localStorage.getItem(key);

          console.log('-----------------');
          console.log('localStorage length: ' + localStorage.length);
          console.log('selectedItems.length: ' + selectedItems.length);
          console.log('savedList.length: ' + savedList.length);
          // console.log('localStorage data: ' + key + " : " + value);
          console.log('-----------------');

          //paintText(localStorage.getItem(savedList));

          // savedList 出力
          let tableBody = document.querySelector("#selected-items");
          tableBody.innerHTML = "";

          for (let i = 0; i < savedList.length; i++) {
            let row = document.createElement("tr");
            row.className = "draggable";
            row.draggable = true;

            let cell0 = document.createElement("div");
            cell0.className = "el";

            let cell1 = document.createElement("td");
            cell1.className = "table-ing-name"; //class 속성 추가
            cell1.textContent = savedList[i].ingredient;
            cell1.value = savedList[i].ingredientValue;

            let cell2 = document.createElement("td");
            cell2.className = "table-ing-qty";
            cell2.textContent = savedList[i].qty;
            cell2.value = savedList[i].qtyValue;

            let cell3 = document.createElement("td");
            cell3.className = "table-ing-unit";
            cell3.textContent = savedList[i].unit;
            cell3.value = savedList[i].unitValue;

            let cell4 = document.createElement("td");
            cell4.className = "table-ing-unit";
            let button = document.createElement("button");
            button.type = "button";
            button.className = "btn-close";
            button.id = "deleteBtn";
            button.dataset.tableIngName = cell1.value;
            cell4.appendChild(button);


            cell0.appendChild(cell1);
            cell0.appendChild(cell2);
            cell0.appendChild(cell3);
            cell0.appendChild(cell4);

            row.appendChild(cell0);
            row.appendChild(cell1);
            row.appendChild(cell2);
            row.appendChild(cell3);
            row.appendChild(cell4);

            tableBody.appendChild(row);




          }

        }

        // document.addEventListener("DOMContentLoaded", function () {
        //   tableBody.addEventListener("click", (event) => {
        //     const target = event.target;
        //     const id = event.target.dataset.tableIngName;
        //     console.log('id 1: ' + id);

        //   });
        // });

      }




    });

  });


  // 詳細カテゴリー
  $(document).ready(function () {
    $("#main-category-dropdown").change(function () {
      var parentId = $(this).val();
      $.ajax({
        type: "POST",
        url: "/ingredient/sub",
        data: { parentId: parentId },
        dataType: "json",
        success: function (response) {

          // リセット
          $("#sub-category-dropdown").empty();

          // メインカテゴリーを選えらび直すと → 以下のリストリセット
          var option = $("<option>").text("選択してください").attr("value", "");

          $("#ingredient-dropdown").empty();
          $("#ingredient-dropdown").append(option);

          $(function () {
            $("#qtyDirect").hide(); // Input Hidden
            $("#qty-dropdown").change(function () {
              if ($("#qty-dropdown").val() == "direct") {
                $("#qtyDirect").show(); // Input Display
              } else {
                $("#qtyDirect").hide(); // Input Hidden
              }
            });
            $("#qty-dropdown option:first").prop("selected", true);
          });

          $("#unit-dropdown option:first").prop("selected", true);

          // 詳細カテゴリーをリストに入れる
          $.each(response, function (index, subcategory) {

            // 詳細カテゴリーがメインカテゴリーと一緒
            if (subcategory.level == 0 && index == 0) {
              var option = $("<option>").text("-").attr("value", subcategory.id);
              $("#sub-category-dropdown").append(option);
            }

            // 「選択してください」を入れる
            if (subcategory.level == 1 && index == 0) {
              var option = $("<option>").text("選択してください").attr("value", subcategory.id);
              $("#sub-category-dropdown").append(option);
            }

            // 詳細カテゴリーを出力
            if (subcategory.level == 1) {
              var option = $("<option>").text(subcategory.name).attr("value", subcategory.id);
              $("#sub-category-dropdown").append(option);
            }
          });
        },
        error: function (xhr, textStatus, errorThrown) {
          console.log("Error: " + errorThrown);
        }
      });
    });
  });

  // 材料
  $(document).ready(function () {
    $("#sub-category-dropdown").change(function () {
      var categoryId = $(this).val();
      $.ajax({
        type: "POST",
        url: "/ingredient/ing",
        data: { categoryId: categoryId },
        dataType: "json",
        success: function (response) {

          // リセット
          var option = $("<option>").text("選択してください").attr("value", "");
          $("#ingredient-dropdown").empty();
          $("#ingredient-dropdown").append(option);

          // 詳細カテゴリーを選えらび直すと → 以下のリストリセット
          $(function () {
            $("#qtyDirect").hide(); // Input Hidden
            $("#qty-dropdown").change(function () {
              if ($("#qty-dropdown").val() == "direct") {
                $("#qtyDirect").show(); // Input Display
              } else {
                $("#qtyDirect").hide(); // Input Hidden
              }
            });
            $("#qty-dropdown option:first").prop("selected", true);
          });

          $("#unit-dropdown option:first").prop("selected", true);

          // 材料をリストに入れる
          $.each(response, function (index, ingredient) {

            // 「選択してください」を入れる
            if (index == 0) {
              var option = $("<option>").text(ingredient.name).attr("value", ingredient.id);
              $("#ingredient-dropdown").append(option);
            } else { // 材料を出力
              var option = $("<option>").text(ingredient.name).attr("value", ingredient.id);
              $("#ingredient-dropdown").append(option);
            }
          });
        },
        error: function (xhr, textStatus, errorThrown) {
          console.log("Error: " + errorThrown);
        }
      });
    });
  });

  // 材料を選えらび直すと → 以下のリストリセット
  $(document).ready(function () {
    $("#ingredient-dropdown").change(function () {
      $(function () {
        $("#qtyDirect").hide(); // Input Hidden
        $("#qty-dropdown").change(function () {
          if ($("#qty-dropdown").val() == "direct") {
            $("#qtyDirect").show(); // Input Display
          } else {
            $("#qtyDirect").hide(); // Input Hidden
          }
        });
        $("#qty-dropdown option:first").prop("selected", true);
      });

      $("#unit-dropdown option:first").prop("selected", true);

    });
  });

  // Dynamic Table 材料
  let selectedItems = [];
  let savedList = [];
  let saveLength;


  document.querySelector("#add-button").addEventListener("click", function () {
    // 出力用
    let mainCategory = document.querySelector("#main-category-dropdown option:checked").textContent;
    let subCategory = document.querySelector("#sub-category-dropdown option:checked").textContent;
    let ingredient = document.querySelector("#ingredient-dropdown option:checked").textContent;
    let qty;
    if (document.querySelector("#qty-dropdown").value === "direct") {
      qty = document.querySelector("#qtyDirect").value;
    } else {
      qty = document.querySelector("#qty-dropdown option:checked").textContent;
    }
    let unit = document.querySelector("#unit-dropdown option:checked").textContent;

    // データ送信用
    let ingredientValue = document.querySelector("#ingredient-dropdown").value; // ingredient.id
    let qtyValue = document.querySelector("#qty-dropdown").value; // quantity
    let unitValue = document.querySelector("#unit-dropdown").value; // unit.id

    // Object: selectedItemsに保存
    selectedItems.push({
      mainCategory: mainCategory,
      subCategory: subCategory,
      ingredient: ingredient,
      qty: qty,
      unit: unit,
      ingredientValue: ingredientValue,
      qtyValue: qty,
      unitValue: unitValue
    });

    $("#main-category-dropdown option:first").prop("selected", true);
    //$("#main-category-dropdown").empty();
    $("#sub-category-dropdown").empty();
    $("#ingredient-dropdown").empty();
    $("#unit-dropdown option:first").prop("selected", true);

    //$("#main-category-dropdown").append($("<option>").text("選択してください").attr("value", ""));
    $("#sub-category-dropdown").append($("<option>").text("選択してください").attr("value", ""));
    $("#ingredient-dropdown").append($("<option>").text("選択してください").attr("value", ""));
    $("#unit-dropdown").append($("<option>").text("選択してください").attr("value", ""));

    $(function () {
      $("#qtyDirect").hide(); // Input Hidden
      $("#qty-dropdown").change(function () {
        if ($("#qty-dropdown").val() == "direct") {
          $("#qtyDirect").show(); // Input Display
        } else {
          $("#qtyDirect").hide(); // Input Hidden
        }
      });
      $("#qty-dropdown option:first").prop("selected", true);
    });

    // 出力
    let tableBody = document.querySelector("#selected-items");
    tableBody.innerHTML = "";

    // if savedList is already exist
    if (savedList.length > 0) {

      saveLength = savedList.length;
      console.log('saveLength: ' + saveLength);

      for (let i = 0; i < savedList.length; i++) {
        let row = document.createElement("tr");
        row.className = "draggable";
        row.draggable = true;

        let cell0 = document.createElement("div");
        cell0.className = "el";

        let cell1 = document.createElement("td");
        cell1.className = "table-ing-name"; //class 속성 추가
        cell1.textContent = savedList[i].ingredient;
        cell1.value = savedList[i].ingredientValue;

        let cell2 = document.createElement("td");
        cell2.className = "table-ing-qty";
        cell2.textContent = savedList[i].qty;
        cell2.value = savedList[i].qtyValue;

        let cell3 = document.createElement("td");
        cell3.className = "table-ing-unit";
        cell3.textContent = savedList[i].unit;
        cell3.value = savedList[i].unitValue;

        let cell4 = document.createElement("td");
        cell4.className = "table-ing-unit";
        let button = document.createElement("button");
        button.type = "button";
        button.className = "btn-close";
        button.id = "deleteBtn";
        button.dataset.tableIngName = cell1.value;
        cell4.appendChild(button);

        cell0.appendChild(cell1);
        cell0.appendChild(cell2);
        cell0.appendChild(cell3);
        cell0.appendChild(cell4);

        row.appendChild(cell0);
        row.appendChild(cell1);
        row.appendChild(cell2);
        row.appendChild(cell3);
        row.appendChild(cell4);

        tableBody.appendChild(row);
      }
    }



    for (let i = 0; i < selectedItems.length; i++) {
      let row = document.createElement("tr");
      row.className = "draggable";
      row.draggable = true;

      let cell0 = document.createElement("div");
      cell0.className = "el";

      let cell1 = document.createElement("td");
      cell1.className = "table-ing-name"; //class 속성 추가
      cell1.textContent = selectedItems[i].ingredient + ' (' + selectedItems[i].subCategory + ', ' + selectedItems[i].mainCategory + ')';
      cell1.value = selectedItems[i].ingredientValue;

      let cell2 = document.createElement("td");
      cell2.className = "table-ing-qty";
      cell2.textContent = selectedItems[i].qty;
      cell2.value = selectedItems[i].qtyValue;

      let cell3 = document.createElement("td");
      cell3.className = "table-ing-unit";
      cell3.textContent = selectedItems[i].unit;
      cell3.value = selectedItems[i].unitValue;

      let cell4 = document.createElement("td");
      cell4.className = "table-ing-unit";
      let button = document.createElement("button");
      button.type = "button";
      button.className = "btn-close";
      button.id = "deleteBtn";
      button.dataset.tableIngName = cell1.value;
      cell4.appendChild(button);

      cell0.appendChild(cell1);
      cell0.appendChild(cell2);
      cell0.appendChild(cell3);
      cell0.appendChild(cell4);

      row.appendChild(cell0);
      row.appendChild(cell1);
      row.appendChild(cell2);
      row.appendChild(cell3);
      row.appendChild(cell4);

      tableBody.appendChild(row);
    }



  });

  // Exit Button
  selectedItems

  // データ保存
  const saveButton = document.getElementById("save-button");
  const tableBody = document.getElementById("selected-items");
  console.log('tableBody.rows.length: ' + tableBody.rows.length);

  saveButton.addEventListener("click", () => {



    // データがあれば
    if (tableBody.rows.length > 0) {
      savedIngList(); // 保存
      //localStorage.setItem("savedList", JSON.stringify(savedList));
    } else {
      console.log('保存するデータがありません');
      // TODO: text append 保存する材料がありません
    }

  });

  function savedIngList() {

    console.log('selectedItems: ' + selectedItems.length);



    if (saveLength > 0) {

      for (let i = saveLength; i < tableBody.rows.length; i++) {

        // TableBodyのi番目のcells
        const cells = tableBody.rows[i].cells;

        // RecipeIngredientに必要なデータ
        let ingredient;
        let qty;
        let unit;
        let ingredientValue; // ingredient.id
        let qtyValue; // quantity
        let unitValue; // unit.id

        // 各cellsのj番目の要素
        for (let j = 0; j < cells.length; j++) {
          switch (j) {
            case 0:
              ingredient = cells[j].textContent;
              ingredientValue = cells[j].value;
              break;
            case 1:
              qty = cells[j].textContent;
              qtyValue = cells[j].value;
              break;
            case 2:
              unit = cells[j].textContent;
              unitValue = cells[j].value;
              break;
          }
        }

        // Object: savedListに保存
        savedList.push({
          ingredient: ingredient,
          unit: unit,
          qty: qty,
          ingredientId: ingredientValue,
          qtyValue: qtyValue,
          unitId: unitValue
        });

      }
    } else {
      for (let i = 0; i < tableBody.rows.length; i++) {

        // TableBodyのi番目のcells
        const cells = tableBody.rows[i].cells;

        // RecipeIngredientに必要なデータ
        let ingredient;
        let qty;
        let unit;
        let ingredientValue; // ingredient.id
        let qtyValue; // quantity
        let unitValue; // unit.id

        // 各cellsのj番目の要素
        for (let j = 0; j < cells.length; j++) {
          switch (j) {
            case 0:
              ingredient = cells[j].textContent;
              ingredientValue = cells[j].value;
              break;
            case 1:
              qty = cells[j].textContent;
              qtyValue = cells[j].value;
              break;
            case 2:
              unit = cells[j].textContent;
              unitValue = cells[j].value;
              break;
          }
        }

        // Object: savedListに保存
        savedList.push({
          ingredient: ingredient,
          unit: unit,
          qty: qty,
          ingredientId: ingredientValue,
          qtyValue: qtyValue,
          unitId: unitValue
        });

      }
    }
  }

  // 削除
  document.addEventListener("DOMContentLoaded", function () {
    tableBody.addEventListener("click", (event) => {
      const target = event.target;
      const id = event.target.dataset.tableIngName;
      console.log('id 1: ' + id);
      console.log('selectedItems.indexOf(id) ' + selectedItems.indexOf(id));
      savedList.splice(savedList.indexOf(id), 1);

    });
  });


  // writeFormSubmitの前
  document.getElementById('writeForm').addEventListener('submit', function (evt) {
    evt.preventDefault();
    // savedListをJSON.stringにして、input hiddenに入れる
    $('#send-list-input').val(JSON.stringify(savedList));
    this.submit();
  })

  // defaultイメージ設定
  function setDefaultImage(img) {
    img.src = '/assets/img/default.png';
  }





  var input = document.getElementById("input");
  var initLabel = document.getElementById("label");

  input.addEventListener("change", (event) => {
    const files = changeEvent(event);
    handleUpdate(files);
  });

  initLabel.addEventListener("mouseover", (event) => {
    event.preventDefault();
    const label = document.getElementById("label");
    label?.classList.add("label--hover");
  });

  initLabel.addEventListener("mouseout", (event) => {
    event.preventDefault();
    const label = document.getElementById("label");
    label?.classList.remove("label--hover");
  });

  initLabel.addEventListener("dragenter", (event) => {
    event.preventDefault();
    console.log("dragenter");
    const label = document.getElementById("label");
    label?.classList.add("label--hover");
  });

  initLabel.addEventListener("dragover", (event) => {
    console.log("dragover");
    event.preventDefault();
  });

  initLabel.addEventListener("dragleave", (event) => {
    event.preventDefault();
    console.log("dragleave");
    const label = document.getElementById("label");
    label?.classList.remove("label--hover");
  });

  initLabel.addEventListener("drop", (event) => {
    event.preventDefault();
    console.log("drop");
    const label = document.getElementById("label");
    label?.classList.remove("label--hover");
    const files = event.dataTransfer?.files;
    handleUpdate([...files]);
  });

  // document.addEventListener("dragenter", (event) => {
  //   event.preventDefault();
  //   console.log("dragenter");
  //   if (event.target.className === "inner") {
  //     event.target.style.background = "#616161";
  //   }
  // });

  // document.addEventListener("dragover", (event) => {
  //   console.log("dragover");
  //   event.preventDefault();
  // });

  // document.addEventListener("dragleave", (event) => {
  //   event.preventDefault();
  //   console.log("dragleave");
  //   if (event.target.className === "inner") {
  //     event.target.style.background = "#3a3a3a";
  //   }
  // });

  // document.addEventListener("drop", (event) => {
  //   event.preventDefault();
  //   console.log("drop");
  //   if (event.target.className === "inner") {
  //     const files = event.dataTransfer?.files;
  //     event.target.style.background = "#3a3a3a";
  //     handleUpdate([...files]);
  //   }
  // });

  function changeEvent(event) {
    const { target } = event;
    return [...target.files];
  };

  function handleUpdate(fileList) {
    const preview = document.getElementById("preview");

    const file = fileList[0];
    const reader = new FileReader();
    reader.addEventListener("load", (event) => {
      const img = el("img", {
        className: "embed-img",
        src: event.target?.result,
      });
      const imgContainer = el("div", { className: "container-img" }, img);
      preview.innerHTML = ""; // clear any existing preview
      preview.append(imgContainer);
    });
    reader.readAsDataURL(file);
  };

  function el(nodeName, attributes, ...children) {
    const node =
      nodeName === "fragment"
        ? document.createDocumentFragment()
        : document.createElement(nodeName);

    Object.entries(attributes).forEach(([key, value]) => {
      if (key === "events") {
        Object.entries(value).forEach(([type, listener]) => {
          node.addEventListener(type, listener);
        });
      } else if (key in node) {
        try {
          node[key] = value;
        } catch (err) {
          node.setAttribute(key, value);
        }
      } else {
        node.setAttribute(key, value);
      }
    });

    children.forEach((childNode) => {
      if (typeof childNode === "string") {
        node.appendChild(document.createTextNode(childNode));
      } else {
        node.appendChild(childNode);
      }
    });

    return node;
  }



  input.onfocus = function () {
    browsers.style.display = 'block';
    input.style.borderRadius = "5px 5px 0 0";
  };
  for (let option of browsers.options) {
    option.onclick = function () {
      input.value = option.value;
      browsers.style.display = 'none';
      input.style.borderRadius = "5px";
    }
  };

  input.oninput = function () {
    currentFocus = -1;
    var text = input.value.toUpperCase();
    for (let option of browsers.options) {
      if (option.value.toUpperCase().indexOf(text) > -1) {
        option.style.display = "block";
      } else {
        option.style.display = "none";
      }
    };
  }
  var currentFocus = -1;
  input.onkeydown = function (e) {
    if (e.keyCode == 40) {
      currentFocus++
      addActive(browsers.options);
    }
    else if (e.keyCode == 38) {
      currentFocus--
      addActive(browsers.options);
    }
    else if (e.keyCode == 13) {
      e.preventDefault();
      if (currentFocus > -1) {
        /*and simulate a click on the "active" item:*/
        if (browsers.options) browsers.options[currentFocus].click();
      }
    }
  }

  function addActive(x) {
    if (!x) return false;
    removeActive(x);
    if (currentFocus >= x.length) currentFocus = 0;
    if (currentFocus < 0) currentFocus = (x.length - 1);
    x[currentFocus].classList.add("active");
  }
  function removeActive(x) {
    for (var i = 0; i < x.length; i++) {
      x[i].classList.remove("active");
    }
  }

</script>

</html>